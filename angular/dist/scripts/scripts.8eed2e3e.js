"use strict";angular.module("angularApp",["ngAnimate","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]),angular.module("angularApp").controller("MainCtrl",["$scope","$http","$location",function(a,b,c){function d(a){i.seek((a.start-a.duration)/1e3),i.play()}function e(){void 0!==j&&clearTimeout(j),k=[]}function f(){if(void 0!==j&&clearTimeout(j),!n)return void(o=f);var a=k.shift();a?(d(a),j=setTimeout(function(){f()},3*a.duration)):i.pause()}function g(){if(n=l&&m,o&&n){var a=o;o=void 0,a()}}function h(){i.getCurrentTime(function(b){a.$apply(function(){a.time=b}),p&&setTimeout(h,500)})}var i=SRG.PlayerManager.getPlayer("player");i.stop(),a.query=c.search().q,a.$watch("query",_.debounce(function(){a.$apply(function(){a.active=void 0,e(),i.stop(),c.search("q",a.query).replace(),b({url:"/search",params:{q:a.query}}).success(function(b,c,d,e){if(e.params.q===a.query){a.shows=b;var f=b[0].episodes[0];f&&f.matches&&a.activate(f)}})})}),200),a.seek=function(a){e(),d(a)};var j,k=[];i.addEventListener("paused",function(){e()});var l,m,n,o;i.addEventListener("media_seekable",function(){l=!0,g()}),i.addEventListener("loaded",function(){m=!0,l=!1,g()}),a.time=0;var p;i.addEventListener("playing",function(){p=!0,h()}),i.addEventListener("paused",function(){p=!1}),i.addEventListener("stopped",function(){p=!1});var q=function(){var a=d3.time.format("%X");return function(b){var c=a(new Date(0,0,0,0,0,0,b));return c=c.replace(/^[\:0]{0,4}/,""),c=new Array(9-c.length).join("&nbsp;")+c}}();a.activate=function(c,d){(a.active!==c||d)&&(n=l=m=!1,i.stop(),i.load("urn:srf:ais:video:"+c.videoId)),a.active=c,a.transcript=[],setTimeout(function(){i.getUrn(function(b){a.active&&b!=="urn:srf:ais:video:"+a.active.videoId&&a.$apply(function(){a.activate(a.active,!0)})})},1e3);var e=new RegExp(a.query.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),"gi");b.get("/"+c.transcript).success(function(b){a.transcript=d3.tsv.parse(b,function(a){return a.matches=a.text.match(e),a.matchText=a.text.replace(e,"<mark>$&</mark>"),a.humanTime=q(a.start),a.start=+a.start,a.end=+a.end,a.duration=+a.duration,a}),k=a.transcript.filter(function(a){return a.matches}),f()})}}]),angular.module("angularApp").directive("transcript",function(){return{templateUrl:"views/transcript.html",restrict:"A",scope:{transcript:"=",time:"@",seek:"&"},link:function(a,b){a.$watch("time",function(){var c=1e3*a.time,d=_.last((a.transcript||[]).filter(function(a){return a.start<=c}));if(d){a.activeIndex=d.elementIndex;var e=b.height(),f=b.find(".caption-paragraph:eq("+d.elementIndex+")");b.animate({scrollTop:f.position().top+b.scrollTop()-e/3,queue:!1})}})}}});