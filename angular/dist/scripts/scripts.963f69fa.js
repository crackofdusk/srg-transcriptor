"use strict";angular.module("angularApp",["ngAnimate","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]),angular.module("angularApp").controller("MainCtrl",["$scope","$http","$location",function(a,b,c){function d(a){h.seek((a.start-a.duration)/1e3),h.play()}function e(){void 0!==i&&clearTimeout(i),j=[]}function f(){if(void 0!==i&&clearTimeout(i),!m)return void(n=f);var a=j.shift();a?(d(a),i=setTimeout(function(){f()},3*a.duration)):h.pause()}function g(){if(m=k&&l,n&&m){var a=n;n=void 0,a()}}var h=SRG.PlayerManager.getPlayer("player");h.stop(),a.query=c.search().q,a.$watch("query",_.debounce(function(){a.$apply(function(){a.active=void 0,e(),h.stop(),c.search("q",a.query).replace(),b({url:"/search",params:{q:a.query}}).success(function(b,c,d,e){if(e.params.q===a.query){a.shows=b;var f=b[0].episodes[0];f&&f.matches&&a.activate(f)}})})}),200),a.seek=function(a){e(),d(a)};var i,j=[];h.addEventListener("paused",function(){e()});var k,l,m,n;h.addEventListener("media_seekable",function(){k=!0,g()}),h.addEventListener("loaded",function(){l=!0,k=!1,g()}),a.time=0;var o,p=0,q=_.throttle(function(){a.$apply(function(){a.time=p})},500,{leading:!0,trailing:!0});h.addEventListener("time_update",function(a){p=a.data.seconds,q()}),h.addEventListener("playing",function(){o=!0}),h.addEventListener("paused",function(){o=!1}),h.addEventListener("stopped",function(){o=!1});var r=function(){var a=d3.time.format("%X");return function(b){var c=a(new Date(0,0,0,0,0,0,b));return c=c.replace(/^[\:0]{0,4}/,""),c=new Array(9-c.length).join("&nbsp;")+c}}();a.activate=function(c,d){(a.active!==c||d)&&(m=k=l=!1,h.stop(),h.load("urn:srf:ais:video:"+c.videoId)),a.active=c,a.transcript=[],setTimeout(function(){h.getUrn(function(b){a.active&&b!=="urn:srf:ais:video:"+a.active.videoId&&a.$apply(function(){a.activate(a.active,!0)})})},1e3);var e=new RegExp(a.query.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),"gi");b.get("/"+c.transcript).success(function(b){a.transcript=d3.tsv.parse(b,function(a){return a.matches=a.text.match(e),a.matchText=a.text.replace(e,"<mark>$&</mark>"),a.humanTime=r(a.start),a.start=+a.start,a.end=+a.end,a.duration=+a.duration,a}),j=a.transcript.filter(function(a){return a.matches}),f()})}}]),angular.module("angularApp").directive("transcript",function(){return{templateUrl:"views/transcript.html",restrict:"A",scope:{transcript:"=",time:"@",seek:"&"},link:function(a,b){a.$watch("time",function(){var c=1e3*a.time,d=_.last((a.transcript||[]).filter(function(a){return a.start<=c}));if(d){a.activeIndex=d.elementIndex;var e=b.height(),f=b.find(".caption-paragraph:eq("+d.elementIndex+")");b.animate({scrollTop:f.position().top+b.scrollTop()-e/3,queue:!1})}})}}});